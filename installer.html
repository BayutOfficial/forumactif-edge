<style type="text/css">#fae_log { background:#EEE; border:1px solid #CCC; height:150px; margin:6px 0; overflow-y:auto; }
#fae_progress { background:#CCC; height:30px; width:100%; position:relative; }
#fae_prog_bar { height:30px; background:#69C; width:0%; }
#fae_prog_number { color:#FFF; font-size:16px; font-family:Arial; position:absolute; left:50%; top:50%; margin:-8px -8px 0 0; }

.fae_msg_log { margin:3px; }</style>

<h1 class="page-title">Forumactif Edge Control Panel</h1>
<p>This panel allows you to install, uninstall, and update <a href="https://github.com/SethClydesdale/forumactif-edge" target="_blank">Forumactif Edge</a>. Get ready to experience your forum in a more modern and responsive way!</p>

<h3 class="h3">Log</h3>
<div id="fae_log"></div>
<div id="fae_progress"></div>

<div id="fae_actions" style="display:none;">
  <h3 class="h3">Actions</h3>
  <div id="fae_options">
    <input id="fae_install" type="button" value="Install" />
    <input id="fae_uninstall" type="button" value="Uninstall" style="display:none;" />
    <input id="fae_update" type="button" value="Check for updates" style="display:none;" />
  </div>
</div>

<script type="text/javascript">//<![CDATA[
(function() {
  var FAE = {
    logger : document.getElementById('fae_log'),
    log : function(str, css) {
      FAE.logger.insertAdjacentHTML('beforeend', '<div class="fae_msg_log" ' + (css ? 'style="' + css + '"' : '') + '>' + str + '</div>');
      FAE.logger.scrollTop = 99999;
    },


    bar : document.getElementById('fae_progress'),
    progress : function() {
      var percent = FAE.index / FAE.quota * 100;
      FAE.bar.innerHTML = '<div id="fae_prog_bar" style="width:' + percent + '%;"></div><span id="fae_prog_number">' + (percent == 100 ? 'INSTALL COMPLETE' : percent + '%') + '</span>';
    },


    index : -1,
    step : [


      /* -- STEP 0 -- */
      {
        info : 'Changing forum version to phpbb3',
        type : 'POST',
         url : 'part=themes&sub=styles&mode=version&extended_admin=1',
        data : {
                     tpl : 'prosilver',
              keep_theme : 2,
          change_version : 'Save'
        }
      },


      /* -- STEP 1 -- */
      {
        info : 'Unoptimizing and deactivating default CSS',
        type : 'POST',
         url : 'part=themes&sub=logos&mode=css&extended_admin=1',
        data : {
                 css_base : 0,
             optimize_css : 0,
          submit_base_css : 'Save'
        }
      },


      /* -- STEP 2 -- */
      {
        info : 'Getting fa_edge.css',
        type : 'GET',
         url : 'https://raw.githubusercontent.com/SethClydesdale/forumactif-edge/master/fa_edge.css',
        func : function(d) {
          FAE.step[3].data.edit_code = d;
        }
      },


      /* -- STEP 3 -- */
      {
        info : 'Installing fa_edge.css',
        type : 'POST',
         url : 'part=themes&sub=logos&mode=css&extended_admin=1',
        data : {
          edit_code : '',
             submit : 'Submit'
        }
      },

      /* -- STEP 4 -- */
      {
        info : 'Getting all.js',
        type : 'GET',
         url : 'https://raw.githubusercontent.com/SethClydesdale/forumactif-edge/master/javascripts/in-all-the-pages/all.js',
        func : function(d) {
          FAE.step[5].data.content = d;
        }
      },


      /* -- STEP 5 -- */
      {
        info : 'Installing all.js',
        type : 'POST',
         url : 'part=modules&sub=html&mode=js_edit&extended_admin=1',
        data : {
                     title : '[FA EDGE] ALL.JS',
          'js_placement[]' : 'allpages',
                   content : '',
                      mode : 'save',
                    submit : 'Submit'
        }
      },


      /* -- STEP 6 -- */
      {
        info : 'Getting homepage.js',
        type : 'GET',
         url : 'https://raw.githubusercontent.com/SethClydesdale/forumactif-edge/master/javascripts/in-the-homepage/homepage.js',
        func : function(d) {
          FAE.step[7].data.content = d;
        }
      },


      /* -- STEP 7 -- */
      {
        info : 'Installing homepage.js',
        type : 'POST',
         url : 'part=modules&sub=html&mode=js_edit&extended_admin=1',
        data : {
                     title : '[FA EDGE] HOMEPAGE.JS',
          'js_placement[]' : 'index',
                   content : '',
                      mode : 'save',
                    submit : 'Submit'
        }
      }


    ],


    // proceed to and execute the next step in the installation
    next : function() {
      if (++FAE.index >= FAE.quota) {
        FAE.log('Install has completed successfully!', 'color:#8B5;font-weight:bold;');

      } else {
        var step = FAE.step[FAE.index];
        FAE.log(step.info + '...');

        if (step.type == 'POST') {
          $.post('/admin/index.forum?' + step.url + FAE.tid, step.data, FAE.next);

        } else if (step.type == 'GET') {
          $.get(step.url, function(d) {
            step.func(d);
            FAE.next();
          });

        }

      }

      FAE.progress();
    }


  };

  FAE.quota = FAE.step.length; // cache the step length
  window.FAE = FAE; // define FAE in the global namespace

  // stuff that needs to be executed when the doc is ready
  $(function() {
    var admin = $('a[href^="/admin/"]')[0], // get the AP link so we can fetch the TID
        installed = document.getElementById('fa_edge');

    // only allow the founder to install the theme
    if (_userdata.user_id == 1 && admin) {
      FAE.tid = admin.href.replace(/.*?(&tid=.*)/, '$1'); // cache the tid
      document.getElementById('fae_actions').style.display = 'block';

      document.getElementById('fae_install').onclick = function() {
        var yes = confirm('Are you sure you want to ' + ( installed ? 're' : '' ) + 'install Forumactif Edge? This will overwrite your current theme.');
        if (yes) {
          FAE.next();
        }
      };

      // extra actions for when the theme is installed.
      if (installed) {
        var uninstall = document.getElementById('fae_uninstall'),
            update = document.getElementById('fae_update');

        $([uninstall, update]).show();

        uninstall.onclick = function() {
          var yes = confirm('Are you sure you want to uninstall Forumactif Edge? You will lose your current changes to this theme.');
          if (yes) {

          }
        };

        update.onclick = function() {
          FAE.log('Checking for updates on Github...');
        };
      }

    } else {
      FAE.log('Only <a href="/u1">the founder</a> may use this control panel.', 'color:#E53;font-weight:bold;');
    }
  });
}());
//]]></script>
